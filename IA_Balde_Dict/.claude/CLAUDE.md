# Projeto: DICT Rate Limit (Token Bucket) - Sistema de Gest√£o de Baldes de Fichas

## üéØ Vis√£o Geral Executiva

Implementa√ß√£o profissional do sistema de **Gest√£o e Monitoramento de Rate Limits (Token Bucket)** do DICT BACEN conforme Manual Operacional Cap√≠tulo 19, seguindo os **padr√µes arquiteturais do Connector-Dict** (Clean Architecture, Event-Driven com Pulsar, Temporal Workflows para monitoramento cont√≠nuo).

**Objetivo**: Desenvolver feature production-ready que permite ao PSP LBPay:
1. **Consultar** pol√≠ticas de limita√ß√£o (baldes) em tempo real via API DICT
2. **Monitorar** continuamente o estado dos baldes atrav√©s de workflows Temporal
3. **Alertar** quando baldes estiverem pr√≥ximos do esgotamento
4. **Armazenar** hist√≥rico de consultas para an√°lise e compliance
5. **Integrar** com sistema de observabilidade para dashboards operacionais

## ü™£ Algoritmo Token Bucket - Fundamentos do Rate Limiting

### Conceito Base

O DICT BACEN utiliza o **algoritmo Token Bucket** para controlar o fluxo de requisi√ß√µes. Este √© um algoritmo cl√°ssico de controle de tr√°fego baseado na analogia de um "balde de fichas" (tokens).

### Como Funciona o Token Bucket

#### 1. **Estrutura do Balde**

Cada pol√≠tica de limita√ß√£o (policy) possui um balde com:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              BALDE DE FICHAS                    ‚îÇ
‚îÇ  Policy: ENTRIES_WRITE                          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   Fichas Dispon√≠veis (AvailableTokens)    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ             35,000                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                           ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  Capacidade M√°xima (Capacity): 36,000           ‚îÇ
‚îÇ  Utiliza√ß√£o: 97.2%                              ‚îÇ
‚îÇ  Dispon√≠vel: 2.8% - CR√çTICO!                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

        ‚ñ≤                          ‚îÇ
        ‚îÇ Reposi√ß√£o                ‚îÇ Consumo
        ‚îÇ (Refill)                 ‚ñº
        ‚îÇ
  +1,200 fichas/min         -1 ficha por requisi√ß√£o
```

#### 2. **Par√¢metros Fundamentais**

Para cada pol√≠tica, o DICT retorna 4 par√¢metros cr√≠ticos:

| Par√¢metro | Descri√ß√£o | Exemplo (ENTRIES_WRITE) | Unidade |
|-----------|-----------|-------------------------|---------|
| **AvailableTokens** | Fichas dispon√≠veis no momento da consulta | 35,000 | fichas |
| **Capacity** | Capacidade m√°xima do balde | 36,000 | fichas |
| **RefillTokens** | Quantidade de fichas adicionadas por per√≠odo | 1,200 | fichas |
| **RefillPeriodSec** | Per√≠odo de reposi√ß√£o | 60 | segundos |

#### 3. **Evolu√ß√£o das Fichas ao Longo do Tempo**

##### **Reposi√ß√£o Autom√°tica (Refill)**

O DICT BACEN adiciona fichas ao balde periodicamente:

```
Taxa de reposi√ß√£o = RefillTokens / RefillPeriodSec
Exemplo ENTRIES_WRITE: 1,200 fichas / 60 segundos = 20 fichas/segundo
```

**F√≥rmula de reposi√ß√£o**:
```go
// A cada RefillPeriodSec segundos
tokensToAdd := RefillTokens
if (currentTokens + tokensToAdd) > Capacity {
    currentTokens = Capacity  // Teto m√°ximo
} else {
    currentTokens += tokensToAdd
}
```

**Timeline de reposi√ß√£o**:
```
t=0s:    35,000 fichas
t=60s:   35,000 + 1,200 = 36,000 (atingiu Capacity, descarta excesso)
t=120s:  36,000 (j√° estava no m√°ximo)
t=180s:  36,000 (sem mudan√ßas)
```

##### **Consumo por Requisi√ß√£o**

Cada vez que o PSP faz uma requisi√ß√£o √† API DICT:

```
// Antes da requisi√ß√£o
AvailableTokens = 35,000

// PSP faz POST /entries (criar chave)
AvailableTokens -= 1  // Consome 1 ficha

// Depois da requisi√ß√£o
AvailableTokens = 34,999
```

**Regras de consumo por pol√≠tica**:

| Pol√≠tica | Consumo por Request | Observa√ß√£o |
|----------|---------------------|------------|
| ENTRIES_WRITE | -1 ficha | Status diferente de 500 |
| ENTRIES_READ (status 200) | -1 ficha | Consulta com sucesso |
| ENTRIES_READ (status 404) | -3 fichas | Penalidade por chave inexistente (anti-scan) |
| CLAIMS_WRITE | -1 ficha | Status diferente de 500 |

A pol√≠tica de limita√ß√£o de requisi√ß√µes do DICT estabelece penalidades elevadas (consumo de mais de 1 ficha) exclusivamente para as opera√ß√µes de consulta de chaves (getEntry e getEntryStatistics) que s√£o consideradas "consultas inv√°lidas" (como consultas a chaves n√£o registradas) e que acionam os mecanismos anti-scan.

##### **Cen√°rio de Esgotamento**

```
Timeline de consumo intenso:

t=0s:     AvailableTokens = 1,000
          PSP faz 500 requisi√ß√µes (1 req/s)
t=500s:   AvailableTokens = 1,000 - 500 = 500
          + Reposi√ß√£o: 8 per√≠odos de 60s = 8 * 1,200 = 9,600 fichas
          AvailableTokens = 500 + 9,600 = 10,100

t=600s:   PSP faz 15,000 requisi√ß√µes em burst (limite de capacidade)
          AvailableTokens = 10,100 - 15,000 = -4,900 ‚ùå

          ‚ö†Ô∏è BALDE ESGOTADO!
          AvailableTokens = 0
          Pr√≥ximas requisi√ß√µes retornam HTTP 429 (Too Many Requests)

t=660s:   Reposi√ß√£o: +1,200 fichas
          AvailableTokens = 1,200
          PSP pode fazer 1,200 requisi√ß√µes novamente
```

#### 4. **C√°lculo de Utiliza√ß√£o**

```go
// F√≥rmula utilizada pelo sistema
utilization_pct := ((Capacity - AvailableTokens) / Capacity) * 100

// Exemplo
Capacity = 36,000
AvailableTokens = 3,000
utilization_pct = ((36,000 - 3,000) / 36,000) * 100 = 91.67%
```

**Interpreta√ß√£o dos n√≠veis**:

| Utiliza√ß√£o | AvailableTokens | Severidade | A√ß√£o |
|------------|-----------------|------------|------|
| 0-75% | 9,000+ fichas | ‚úÖ Normal | Nenhuma |
| 75-90% | 3,600-9,000 | ‚ö†Ô∏è Warning | Alerta + Log |
| 90-100% | 0-3,600 | üî¥ Critical | Alerta + Notifica√ß√£o PagerDuty |
| 100% | 0 fichas | üí• Esgotado | HTTP 429 em todas requisi√ß√µes |

#### 5. **Categorias de Participantes (Pol√≠ticas Vari√°veis)**

Algumas pol√≠ticas t√™m par√¢metros diferentes baseados na **categoria do participante**:

**Exemplo: ENTRIES_READ_PARTICIPANT_ANTISCAN**

| Categoria | RefillTokens | Capacity | Taxa (fichas/min) | Volume Di√°rio M√°ximo |
|-----------|--------------|----------|-------------------|----------------------|
| A | 25,000 | 50,000 | 25,000/min | 36M fichas/dia |
| B | 20,000 | 40,000 | 20,000/min | 28.8M fichas/dia |
| C | 15,000 | 30,000 | 15,000/min | 21.6M fichas/dia |
| D | 8,000 | 16,000 | 8,000/min | 11.5M fichas/dia |
| E | 2,500 | 5,000 | 2,500/min | 3.6M fichas/dia |
| F | 250 | 500 | 250/min | 360K fichas/dia |
| G | 25 | 250 | 25/min | 36K fichas/dia |
| H | 2 | 50 | 2/min | 2.9K fichas/dia |

**C√°lculo do volume di√°rio**:
```
Volume di√°rio = (RefillTokens * 60 min/h * 24h/dia) + Capacity inicial
Categoria A = (25,000 * 1,440) + 50,000 = 36,050,000 fichas/dia
```

#### 6. **24 Pol√≠ticas do DICT BACEN**

O sistema monitora **24 pol√≠ticas diferentes**:

| Pol√≠tica | RefillTokens | Capacity | RefillPeriodSec | Escopo |
|----------|--------------|----------|-----------------|--------|
| ENTRIES_WRITE | 1,200 | 36,000 | 60 | PSP |
| ENTRIES_UPDATE | 600 | 600 | 60 | PSP |
| ENTRIES_READ_PARTICIPANT_ANTISCAN | Vari√°vel | Vari√°vel | 60 | PSP (por categoria) |
| ENTRIES_STATISTICS_READ | Vari√°vel | Vari√°vel | 60 | PSP |
| CLAIMS_READ | 600 | 18,000 | 60 | PSP |
| CLAIMS_WRITE | 1,200 | 36,000 | 60 | PSP |
| CLAIMS_LIST_WITH_ROLE | 40 | 200 | 60 | PSP |
| CLAIMS_LIST_WITHOUT_ROLE | 10 | 50 | 60 | PSP |
| SYNC_VERIFICATIONS_WRITE | 10 | 50 | 60 | PSP |
| CIDS_FILES_WRITE | 40 | 200 | 86,400 (1 dia) | PSP |
| CIDS_FILES_READ | 10 | 50 | 60 | PSP |
| CIDS_EVENTS_LIST | 20 | 100 | 60 | PSP |
| CIDS_ENTRIES_READ | 1,200 | 36,000 | 60 | PSP |
| INFRACTION_REPORTS_READ | 600 | 18,000 | 60 | PSP |
| INFRACTION_REPORTS_WRITE | 1,200 | 36,000 | 60 | PSP |
| INFRACTION_REPORTS_LIST_WITH_ROLE | 40 | 200 | 60 | PSP |
| INFRACTION_REPORTS_LIST_WITHOUT_ROLE | 10 | 50 | 60 | PSP |
| KEYS_CHECK | 70 | 70 | 60 | PSP |
| REFUNDS_READ | 1,200 | 36,000 | 60 | PSP |
| REFUNDS_WRITE | 2,400 | 72,000 | 60 | PSP |
| REFUND_LIST_WITH_ROLE | 40 | 200 | 60 | PSP |
| REFUND_LIST_WITHOUT_ROLE | 10 | 50 | 60 | PSP |
| FRAUD_MARKERS_READ | 600 | 18,000 | 60 | PSP |
| FRAUD_MARKERS_WRITE | 1,200 | 36,000 | 60 | PSP |

#### 7. **Implica√ß√µes para Monitoramento**

##### **Por que monitorar a cada 5 minutos?**

```
Cen√°rio cr√≠tico:
- Policy: CLAIMS_LIST_WITHOUT_ROLE
- Capacity: 50 fichas
- RefillTokens: 10 fichas/min
- Consumo m√©dio: 8 fichas/min (uso normal)

Se houver pico de consumo:
- t=0min: AvailableTokens = 50
- t=1min: 50 - 8 + 10 = 52 (ok)
- t=2min: 52 - 8 + 10 = 54 (ok)
- t=3min: PICO! 54 - 60 = -6 ‚Üí AvailableTokens = 0 ‚ùå

Monitoramento a cada 5min:
- Pode detectar balde em 0 muito tarde
- Solu√ß√£o: Cron a cada 5min + alertas em WARNING (20%) e CRITICAL (10%)
- ‚ö†Ô∏è SEM CACHE - Sempre consultar DICT para dados frescos
```

##### **Thresholds definidos (baseado em DUVIDAS.md)**

```go
// WARNING: 20% de capacidade restante (80% utilizado)
WARNING_THRESHOLD := Capacity * 0.20

// CRITICAL: 10% de capacidade restante (90% utilizado)
CRITICAL_THRESHOLD := Capacity * 0.10

// Exemplo ENTRIES_WRITE (Capacity = 36,000)
WARNING := 7,200 fichas (80% utilizado)
CRITICAL := 3,600 fichas (90% utilizado)
```

**Estrat√©gia de alerta**:

| AvailableTokens | Utiliza√ß√£o | Threshold | A√ß√£o |
|-----------------|------------|-----------|------|
| > 7,200 | < 80% | Normal | Nenhuma |
| 3,600 - 7,200 | 80-90% | WARNING | Log + Metrics + Pulsar Event |
| 0 - 3,600 | 90-100% | CRITICAL | Log + Metrics + Pulsar + Prometheus AlertManager |

#### 8. **Resposta do DICT quando Balde Esgota**

Quando `AvailableTokens = 0`:

```xml
HTTP/1.1 429 Too Many Requests
Content-Type: application/xml

<?xml version="1.0" encoding="UTF-8" ?>
<Problem>
    <Type>https://dict.pi.rsfn.net.br/api/v2/error/TooManyRequests</Type>
    <Title>Too Many Requests</Title>
    <Status>429</Status>
    <Detail>Policy ENTRIES_WRITE exceeded rate limit. Please retry after 60 seconds.</Detail>
</Problem>
```

**Impacto no neg√≥cio**:
- ‚ùå Chaves PIX n√£o podem ser criadas
- ‚ùå Claims n√£o podem ser processados
- ‚ùå Opera√ß√µes cr√≠ticas bloqueadas
- üí∞ Perda de receita potencial
- üìâ SLA degradado

**Por isso o monitoramento preventivo √© CR√çTICO!**

---

## üìã Escopo do Projeto

### ‚úÖ In Scope

#### 1. **Dict API - Endpoints REST** (`apps/dict`)
- **GET /api/v1/policies** - Listar todas as pol√≠ticas de limita√ß√£o do participante
- **GET /api/v1/policies/{policy}** - Consultar pol√≠tica espec√≠fica
- Valida√ß√£o de schemas (request/response)
- Integra√ß√£o com Bridge gRPC (chamadas s√≠ncronas ao DICT BACEN)
- Cache Redis para reduzir lat√™ncia (TTL configur√°vel)
- Error handling conforme RFC 9457

#### 2. **Orchestration Worker - Workflows Temporal** (`apps/orchestration-worker`)
- **MonitorPoliciesWorkflow** - Workflow cron (a cada 5 minutos) para monitoramento cont√≠nuo
- **AlertLowBalanceWorkflow** - Child workflow para disparar alertas quando balde < threshold
- **Activities**:
  - `GetPoliciesActivity` - Consultar API DICT via Bridge
  - `StorePolicyStateActivity` - Persistir estado em PostgreSQL
  - `AnalyzeBalanceActivity` - Analisar n√≠veis e identificar riscos
  - `PublishAlertActivity` - Publicar eventos Pulsar para sistemas de alerta
  - `PublishMetricsActivity` - Publicar m√©tricas para observability

#### 3. **Database Layer - PostgreSQL**
- Tabela `dict_rate_limit_policies` - Configura√ß√£o de pol√≠ticas
- Tabela `dict_rate_limit_states` - Hist√≥rico de estados dos baldes
- Tabela `dict_rate_limit_alerts` - Log de alertas disparados
- Indexes otimizados para queries de an√°lise temporal

#### 4. **Pulsar Event Integration**
- Topic `persistent://lb-conn/dict/rate-limit-alerts` - Alertas de baldes baixos
- Topic `persistent://lb-conn/dict/core-events` - Notifica√ß√µes para Core-Dict
- Consumers externos podem integrar para tomar a√ß√µes autom√°ticas

#### 5. **Observability & Monitoring**
- M√©tricas Prometheus:
  - `dict_rate_limit_available_tokens{policy="ENTRIES_WRITE"}` - Gauge
  - `dict_rate_limit_capacity{policy="ENTRIES_WRITE"}` - Gauge
  - `dict_rate_limit_utilization{policy="ENTRIES_WRITE"}` - Gauge (%)
  - `dict_rate_limit_alerts_total` - Counter
  - `dict_rate_limit_404_rate{policy="ENTRIES_READ"}` - Gauge (anti-scan detection)
  - `dict_rate_limit_recovery_eta_seconds{policy="ENTRIES_WRITE"}` - Gauge
  - `dict_rate_limit_exhaustion_projection_seconds{policy="ENTRIES_WRITE"}` - Gauge
- Prometheus AlertManager (local) - Alertas configurados via rules
- Traces OpenTelemetry para debugging
- **Grafana dashboards**: P√≥s-lan√ßamento (time de infra cria depois)
- **PagerDuty/Slack**: P√≥s-lan√ßamento (se necess√°rio, configurado por SRE)

#### 6. **Testing & Quality**
- Unit tests (>85% coverage)
- Integration tests com Testcontainers (PostgreSQL + Pulsar + Redis)
- Temporal workflow replay tests
- Load tests (simular DICT response delays)

### ‚ùå Out of Scope
- **N√ÉO** implementar l√≥gica de controle de rate limit (isso √© responsabilidade do DICT BACEN)
- **N√ÉO** implementar rate limiting local (apenas monitoramento do que o DICT informa)
- **N√ÉO** modificar Bridge gRPC (verificar se endpoints existem; coordenar se necess√°rio)
- **N√ÉO** modificar Core-Dict (apenas consumir eventos Pulsar)
- **N√ÉO** implementar UI/frontend (apenas backend APIs e workflows)

## üèóÔ∏è Arquitetura Detalhada

### Stack Tecnol√≥gica (Conforme Connector-Dict)
- **Language**: Go 1.24.5
- **HTTP Framework**: Huma v2 (Dict API)
- **Database**: PostgreSQL (compartilhado com connector-dict)
- **Message Broker**: Apache Pulsar (t√≥picos novos + reuso de t√≥pico core-events)
- **Workflow Engine**: Temporal (workflows cron + child workflows)
- **RPC Protocol**: gRPC (Bridge para comunica√ß√£o com DICT BACEN)
- **Cache**: ‚ùå **REMOVIDO** - Sempre consultar DICT para dados frescos (sem Redis para rate limit)
- **Observability**: OpenTelemetry + Prometheus + Prometheus AlertManager
- **Testing**: Testify, MockGen, Testcontainers
- **Timezone**: UTC for√ßado em todos os componentes (`TZ=UTC`)
- **Timestamp Authority**: DICT `<ResponseTime>` (n√£o `time.Now()`)

### Arquitetura de Integra√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CONNECTOR-DICT (Existente)                         ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Dict API (apps/dict) - NOVOS ENDPOINTS                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   GET /api/v1/policies          ‚Üí ListPolicies                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   GET /api/v1/policies/{policy} ‚Üí GetPolicy                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Valida√ß√£o de schema (Huma)                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - ‚ùå SEM CACHE - Sempre consultar DICT via Bridge            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - gRPC Bridge Client (s√≠ncrono)                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Error handling (RFC 9457)                                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Timestamp do DICT (<ResponseTime>) para auditoria          ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚îÇ                                                             ‚îÇ
‚îÇ           ‚îÇ gRPC call (sync)                                            ‚îÇ
‚îÇ           ‚ñº                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   Bridge gRPC Client                                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   (infrastructure/grpc/ratelimit/)                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - BridgeRateLimitClient.ListPolicies()                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - BridgeRateLimitClient.GetPolicy(policyName)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ   - Mappers: Bacen ‚Üî gRPC (reutilizar do SDK)                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚îÇ
                              ‚îÇ HTTPS REST API (via Bridge)
                              ‚ñº

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      DICT BACEN API                                     ‚îÇ
‚îÇ                    Cap√≠tulo 19: Consulta de Baldes                      ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  GET /policies/                                                        ‚îÇ
‚îÇ    Response: ListPoliciesResponse (XML)                                ‚îÇ
‚îÇ      - Category: A/B/C/D/E/F/G/H                                       ‚îÇ
‚îÇ      - Policies[]:                                                     ‚îÇ
‚îÇ          - Name: "ENTRIES_WRITE"                                       ‚îÇ
‚îÇ          - AvailableTokens: 35000                                      ‚îÇ
‚îÇ          - Capacity: 36000                                             ‚îÇ
‚îÇ          - RefillTokens: 1200                                          ‚îÇ
‚îÇ          - RefillPeriodSec: 60                                         ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  GET /policies/{policy}                                                ‚îÇ
‚îÇ    Response: GetPolicyResponse (XML)                                   ‚îÇ
‚îÇ      - Category: A                                                     ‚îÇ
‚îÇ      - Policy: {...}                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚ñ≤
                              ‚îÇ Consultas via Bridge
                              ‚îÇ

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           ORCHESTRATION WORKER - NOVOS WORKFLOWS                        ‚îÇ
‚îÇ                    (apps/orchestration-worker)                          ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Temporal Cron Workflow: MonitorPoliciesWorkflow                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Schedule: "*/5 * * * *" (a cada 5 minutos)                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Location: infrastructure/temporal/workflows/ratelimit/          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Loop de Monitoramento:                                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    1. GetPoliciesActivity()                                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - gRPC call to Bridge ‚Üí DICT BACEN                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Retorna lista de todas as policies do PSP                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    2. StorePolicyStateActivity(policies)                         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Persiste em PostgreSQL (dict_rate_limit_states)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Timestamp + snapshot completo                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    3. AnalyzeBalanceActivity(policies)                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Calcula % de utiliza√ß√£o (used/capacity)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Identifica pol√≠ticas em risco:                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         * CRITICAL: <10% dispon√≠vel                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         * WARNING: <25% dispon√≠vel                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Retorna lista de alerts                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    4. Se alerts.length > 0:                                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - PublishAlertActivity(alerts)                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         * Pulsar topic: rate-limit-alerts                       ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         * CoreEvents para Core-Dict                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - StoreAlertsActivity(alerts)                             ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ         * PostgreSQL: dict_rate_limit_alerts                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    5. PublishMetricsActivity(policies)                           ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Prometheus Pushgateway (ou metrics endpoint)            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - Gauges para cada policy                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    6. Sleep at√© pr√≥ximo cron trigger                             ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  Child Workflow: AlertLowBalanceWorkflow (opcional)              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Trigger: On-demand quando threshold atingido                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ                                                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  Fluxo:                                                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    1. RecordAlertActivity(policy, severity)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    2. NotifyOpsTeamActivity(alert) - PagerDuty/Slack            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    3. PublishCoreEventsActivity(alert)                          ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ    4. Se CRITICAL:                                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - ThrottleRequestsActivity (integrar com rate limiter?)   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ       - NOTA: Fora de escopo inicial - apenas alerta            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚îÇ
                              ‚îÇ Persist
                              ‚ñº

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PostgreSQL (Compartilhado)                           ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Tables (NOVAS):                                                       ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  dict_rate_limit_policies                                              ‚îÇ
‚îÇ    - id (PK)                                                           ‚îÇ
‚îÇ    - policy_name (unique)                                              ‚îÇ
‚îÇ    - capacity_max (int)                                                ‚îÇ
‚îÇ    - refill_tokens (int)                                               ‚îÇ
‚îÇ    - refill_period_sec (int)                                           ‚îÇ
‚îÇ    - warning_threshold_pct (default 25)                                ‚îÇ
‚îÇ    - critical_threshold_pct (default 10)                               ‚îÇ
‚îÇ    - enabled (bool)                                                    ‚îÇ
‚îÇ    - created_at, updated_at                                            ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  dict_rate_limit_states                                                ‚îÇ
‚îÇ    - id (PK)                                                           ‚îÇ
‚îÇ    - policy_name (FK)                                                  ‚îÇ
‚îÇ    - available_tokens (int)                                            ‚îÇ
‚îÇ    - capacity (int)                                                    ‚îÇ
‚îÇ    - utilization_pct (decimal)                                         ‚îÇ
‚îÇ    - psp_category (varchar) - A/B/C/D/E/F/G/H (NOVO)                  ‚îÇ
‚îÇ    - consumption_rate_per_minute (int) - Para proje√ß√µes (NOVO)        ‚îÇ
‚îÇ    - recovery_eta_seconds (int) - Tempo at√© 100% (NOVO)               ‚îÇ
‚îÇ    - exhaustion_projection_seconds (int) - Proje√ß√£o esgotamento (NOVO)‚îÇ
‚îÇ    - error_404_rate (decimal) - Taxa de erros 404 (NOVO)              ‚îÇ
‚îÇ    - checked_at (timestamp) - Timestamp do DICT (<ResponseTime>)      ‚îÇ
‚îÇ    - created_at                                                        ‚îÇ
‚îÇ    - INDEX (policy_name, checked_at)                                   ‚îÇ
‚îÇ    - Partition by RANGE (checked_at) - mensais (13 meses)             ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  dict_rate_limit_alerts                                                ‚îÇ
‚îÇ    - id (PK)                                                           ‚îÇ
‚îÇ    - policy_name (FK)                                                  ‚îÇ
‚îÇ    - severity (enum: WARNING, CRITICAL)                                ‚îÇ
‚îÇ    - available_tokens (int)                                            ‚îÇ
‚îÇ    - capacity (int)                                                    ‚îÇ
‚îÇ    - utilization_pct (decimal)                                         ‚îÇ
‚îÇ    - message (text)                                                    ‚îÇ
‚îÇ    - resolved (bool)                                                   ‚îÇ
‚îÇ    - resolved_at (timestamp)                                           ‚îÇ
‚îÇ    - created_at                                                        ‚îÇ
‚îÇ    - INDEX (policy_name, severity, created_at)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚îÇ
                              ‚îÇ Publish Events
                              ‚ñº

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Apache Pulsar                                   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Topic: persistent://lb-conn/dict/rate-limit-alerts                   ‚îÇ
‚îÇ    Schema: Avro/JSON                                                   ‚îÇ
‚îÇ    {                                                                   ‚îÇ
‚îÇ      "timestamp": "2025-10-31T10:30:00Z",                             ‚îÇ
‚îÇ      "policy": "ENTRIES_WRITE",                                        ‚îÇ
‚îÇ      "severity": "CRITICAL",                                           ‚îÇ
‚îÇ      "available": 3000,                                                ‚îÇ
‚îÇ      "capacity": 36000,                                                ‚îÇ
‚îÇ      "utilization": 91.7,                                              ‚îÇ
‚îÇ      "message": "ENTRIES_WRITE balde em n√≠vel cr√≠tico (8.3%)"         ‚îÇ
‚îÇ    }                                                                   ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Topic: persistent://lb-conn/dict/core-events (existente)             ‚îÇ
‚îÇ    Action: ActionRateLimitAlert                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

                              ‚îÇ
                              ‚îÇ Subscribe
                              ‚ñº

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                            CORE-DICT                                    ‚îÇ
‚îÇ                     (Consumer Pulsar - Opcional)                        ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îÇ  Pode consumir alertas e tomar a√ß√µes:                                  ‚îÇ
‚îÇ  - Dashboard de visualiza√ß√£o                                           ‚îÇ
‚îÇ  - Integra√ß√£o com sistemas de alerta (PagerDuty/Slack)                ‚îÇ
‚îÇ  - Logs de auditoria                                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üë• Squad Especializada

### üéØ Core Implementation Team

#### 1. Tech Lead & Solution Architect (Opus) ‚≠ê
**Modelo**: Claude Opus 4
**Responsabilidades**:
- Arquitetura de integra√ß√£o com Dict API + Orchestration Worker
- Design do schema PostgreSQL (policies + states + alerts)
- Defini√ß√£o de Temporal Workflows (Cron + Child)
- Padr√µes de integra√ß√£o Pulsar (topics, schemas)
- Estrat√©gia de integra√ß√£o com Bridge gRPC (verificar endpoints existentes)
- Thresholds de alerta (WARNING: 20%, CRITICAL: 10%) - VALIDADO
- Code review de todas implementa√ß√µes
- Decis√µes t√©cnicas (sem cache, frequ√™ncia monitoramento 5min)

**Arquivos**: `.claude/agents/ratelimit/tech-lead.md`

---

#### 2. Dict API Engineer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Implementar endpoints GET /policies e GET /policies/{policy}
- Schemas (request/response) seguindo padr√£o Huma
- Controllers e handlers HTTP
- Application layer (use cases)
- Integra√ß√£o com Bridge gRPC Client
- ‚ùå **SEM CACHE** - Sempre consultar DICT via Bridge
- Error handling (RFC 9457)
- Parsear `<ResponseTime>` do DICT para auditoria
- Testes unit√°rios e de integra√ß√£o

**Arquivos**: `.claude/agents/ratelimit/dict-api-engineer.md`

**Estrutura de arquivos**:
```
apps/dict/
‚îú‚îÄ‚îÄ handlers/http/
‚îÇ   ‚îú‚îÄ‚îÄ schemas/ratelimit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list_policies.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get_policy.go
‚îÇ   ‚îî‚îÄ‚îÄ ratelimit/
‚îÇ       ‚îú‚îÄ‚îÄ controller.go
‚îÇ       ‚îú‚îÄ‚îÄ list_policies_handler.go
‚îÇ       ‚îî‚îÄ‚îÄ get_policy_handler.go
‚îú‚îÄ‚îÄ application/ratelimit/
‚îÇ   ‚îú‚îÄ‚îÄ application.go
‚îÇ   ‚îú‚îÄ‚îÄ interface.go
‚îÇ   ‚îú‚îÄ‚îÄ list_policies.go
‚îÇ   ‚îî‚îÄ‚îÄ get_policy.go
‚îî‚îÄ‚îÄ infrastructure/grpc/ratelimit/
    ‚îî‚îÄ‚îÄ client.go
```

---

#### 3. Database & Domain Engineer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Schema PostgreSQL (migrations + indexes + partitioning 13 meses)
- Repository layer (`infrastructure/database/repositories/ratelimit/`)
- Domain entities (`domain/ratelimit/`: Policy, PolicyState, Alert)
- Business logic (c√°lculo de utiliza√ß√£o, an√°lise de thresholds)
- **Novos c√°lculos**: ETA recovery, proje√ß√£o de esgotamento, 404 rate
- **Category monitoring**: Detectar mudan√ßas de categoria PSP
- Performance optimization (partition by range, batch inserts)

**Arquivos**: `.claude/agents/ratelimit/db-domain-engineer.md`

**Migrations**:
```
infrastructure/database/migrations/
‚îú‚îÄ‚îÄ 001_create_dict_rate_limit_policies.sql
‚îú‚îÄ‚îÄ 002_create_dict_rate_limit_states.sql
‚îú‚îÄ‚îÄ 003_create_dict_rate_limit_alerts.sql
‚îî‚îÄ‚îÄ 004_create_indexes_and_partitions.sql
```

---

#### 4. Temporal Workflow Engineer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Cron Workflow: MonitorPoliciesWorkflow (*/5 * * * *)
- Child Workflow: AlertLowBalanceWorkflow (opcional)
- Temporal Activities:
  - GetPoliciesActivity (gRPC call ‚Üí usa timestamp DICT)
  - StorePolicyStateActivity (PostgreSQL ‚Üí salva category, ETA, projection)
  - AnalyzeBalanceActivity (business logic ‚Üí thresholds 20%/10%)
  - CalculateETAActivity (recovery time calculation)
  - CalculateProjectionActivity (exhaustion projection)
  - DetectCategoryChangeActivity (PSP category monitoring)
  - PublishAlertActivity (Pulsar)
  - StoreAlertsActivity (PostgreSQL)
  - PublishMetricsActivity (Prometheus ‚Üí inclui 404 rate)
- Retry policies e error handling
- Workflow testing (replay, mocking)

**Arquivos**: `.claude/agents/ratelimit/temporal-engineer.md`

**Estrutura de arquivos**:
```
apps/orchestration-worker/
‚îú‚îÄ‚îÄ infrastructure/temporal/
‚îÇ   ‚îú‚îÄ‚îÄ workflows/ratelimit/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ monitor_policies_workflow.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ alert_low_balance_workflow.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ shared.go
‚îÇ   ‚îî‚îÄ‚îÄ activities/ratelimit/
‚îÇ       ‚îú‚îÄ‚îÄ ratelimit_activity.go
‚îÇ       ‚îú‚îÄ‚îÄ get_policies_activity.go
‚îÇ       ‚îú‚îÄ‚îÄ store_state_activity.go
‚îÇ       ‚îú‚îÄ‚îÄ analyze_balance_activity.go
‚îÇ       ‚îú‚îÄ‚îÄ publish_alert_activity.go
‚îÇ       ‚îú‚îÄ‚îÄ store_alerts_activity.go
‚îÇ       ‚îî‚îÄ‚îÄ publish_metrics_activity.go
```

---

#### 5. Pulsar & Event Integration Specialist (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Pulsar Topic configuration (rate-limit-alerts)
- Event schema validation (Avro/JSON)
- Publishers (AlertPublisher, MetricsPublisher)
- Integration com CoreEvents topic existente
- Schema evolution strategy
- Dead-letter queue setup (optional)

**Arquivos**: `.claude/agents/ratelimit/pulsar-specialist.md`

---

#### 6. gRPC & Bridge Integration Engineer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- gRPC client para Bridge (`infrastructure/grpc/ratelimit/`)
- **A√á√ÉO CR√çTICA**: Verificar se Bridge J√Å tem endpoints de Policies
  - Se SIM: Reutilizar proto definitions existentes
  - Se N√ÉO: Coordenar com time Bridge para implementa√ß√£o
- Proto definitions (se necess√°rio):
  - `ListPoliciesRequest/Response`
  - `GetPolicyRequest/Response`
- Mappers (Bacen ‚Üî gRPC) - reutilizar do SDK se poss√≠vel
- mTLS configuration (reutilizar do grpcGateway)
- Error handling (convert gRPC errors to bacen.Problem)
- Integration testing com mock Bridge

**Arquivos**: `.claude/agents/ratelimit/grpc-engineer.md`

---

### üß™ Quality Assurance Team

#### 7. QA Lead & Test Architect (Opus) ‚≠ê
**Modelo**: Claude Opus 4
**Responsabilidades**:
- Estrat√©gia de testes (unit, integration, workflow replay)
- Test coverage >85% enforcement
- Mock design (Bridge, DICT API, PostgreSQL, Pulsar)
- Temporal workflow testing (deterministic replay)
- Test data generation (pol√≠ticas sint√©ticas)
- Load tests (simular lat√™ncia DICT)

**Arquivos**: `.claude/agents/ratelimit/qa-lead.md`

---

#### 8. Security & BACEN Compliance Auditor (Opus) ‚≠ê
**Modelo**: Claude Opus 4
**Responsabilidades**:
- BACEN Manual Cap. 19 compliance (100% validation)
- Security audit (SQL injection, secrets management)
- Valida√ß√£o de schemas XML ‚Üî Go structs
- LGPD compliance (dados sens√≠veis em logs/m√©tricas)
- Audit trail completeness (todas consultas logadas)

**Arquivos**: `.claude/agents/ratelimit/security-auditor.md`

---

### üìö Documentation & Operations Team

#### 9. Technical Writer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Architecture diagrams (Mermaid)
- Database schema documentation
- Workflow documentation (MonitorPolicies, Alerts)
- Operational runbooks (troubleshooting)
- Environment setup guide
- Migration guide (deploy to production)

**Arquivos**: `.claude/agents/ratelimit/technical-writer.md`

---

#### 10. DevOps & SRE Engineer (Sonnet)
**Modelo**: Claude Sonnet 4
**Responsabilidades**:
- Database migrations (Goose - VALIDADO)
- Temporal cron configuration (*/5 * * * *)
- Pulsar topic creation/configuration
- Kubernetes manifests (diretos, sem Helm - VALIDADO)
- Environment variables (TZ=UTC for√ßado)
- **Grafana dashboards**: P√≥s-lan√ßamento (time de infra cria)
- Alerts (Prometheus AlertManager: rate limit critical/warning)
- **PagerDuty/Slack**: P√≥s-lan√ßamento (se necess√°rio)
- ‚úÖ **Secrets Management**: AWS Secrets Manager (VALIDADO)
  - mTLS certificates (Bridge ‚Üî DICT)
  - Bridge endpoint configuration
  - Database credentials
- Disaster recovery procedures

**Arquivos**: `.claude/agents/ratelimit/devops-engineer.md`

---

## üìÇ Estrutura de Arquivos

```
connector-dict/  (branch: balde_dict)
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ dict/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/http/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/ratelimit/                      # NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list_policies.go
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get_policy.go
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ratelimit/                              # NEW
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ controller.go
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ list_policies_handler.go
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ get_policy_handler.go
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application/ratelimit/                       # NEW
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application.go
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interface.go
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ list_policies.go
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get_policy.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/grpc/ratelimit/               # NEW
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ client.go
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ orchestration-worker/
‚îÇ       ‚îú‚îÄ‚îÄ application/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ usecases/ratelimit/                      # NEW
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ application.go
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitor_policies.go
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ports/
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ratelimit_service.go                 # NEW interface
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ migrations/                          # NEW
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 001_create_dict_rate_limit_policies.sql
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 002_create_dict_rate_limit_states.sql
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 003_create_dict_rate_limit_alerts.sql
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 004_create_indexes_and_partitions.sql
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ repositories/
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ratelimit/                       # NEW
‚îÇ       ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ policy_repository.go
‚îÇ       ‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ state_repository.go
‚îÇ       ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ alert_repository.go
‚îÇ       ‚îÇ   ‚îÇ
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ grpc/
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ratelimit/                           # NEW
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ bridge_ratelimit_client.go
‚îÇ       ‚îÇ   ‚îÇ
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ temporal/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ workflows/
‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ratelimit/                       # NEW
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ monitor_policies_workflow.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ alert_low_balance_workflow.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ shared.go
‚îÇ       ‚îÇ       ‚îÇ
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ activities/
‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ratelimit/                       # NEW
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ratelimit_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ get_policies_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ store_state_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ analyze_balance_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ publish_alert_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ store_alerts_activity.go
‚îÇ       ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ publish_metrics_activity.go
‚îÇ       ‚îÇ       ‚îÇ
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îÇ           ‚îî‚îÄ‚îÄ ratelimit_service.go             # NEW
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ setup/
‚îÇ           ‚îú‚îÄ‚îÄ config.go         # ADD: Pulsar topics, cron schedule
‚îÇ           ‚îú‚îÄ‚îÄ temporal.go       # ADD: Register workflows/activities + START CRON
‚îÇ           ‚îî‚îÄ‚îÄ setup.go          # ADD: Wire ratelimit dependencies
‚îÇ
‚îú‚îÄ‚îÄ domain/ratelimit/                                    # NEW
‚îÇ   ‚îú‚îÄ‚îÄ policy.go
‚îÇ   ‚îú‚îÄ‚îÄ policy_state.go
‚îÇ   ‚îú‚îÄ‚îÄ alert.go
‚îÇ   ‚îî‚îÄ‚îÄ threshold.go
‚îÇ
‚îî‚îÄ‚îÄ shared/
    ‚îî‚îÄ‚îÄ proto/
        ‚îî‚îÄ‚îÄ ratelimit/                                   # NEW (se Bridge n√£o tiver)
            ‚îî‚îÄ‚îÄ dict_ratelimit_service.proto
```

## üìñ Metodologia de Trabalho

### Workflow de Desenvolvimento

```mermaid
graph TB
    A[Tech Lead] -->|Define Architecture & Thresholds| B[Dict API Engineer]
    A -->|Define Architecture & Thresholds| C[DB & Domain Engineer]
    B -->|Implement REST Endpoints| D[gRPC Engineer]
    C -->|Implement Database Layer| E[Temporal Engineer]
    D -->|Implement Bridge Client| E
    E -->|Implement Workflows & Activities| F[Pulsar Specialist]
    F -->|Configure Topics & Publishers| G[QA Lead]
    G -->|Test All Layers| H[Security Auditor]
    H -->|Validate Compliance| I[Technical Writer]
    I -->|Document Everything| J[DevOps Engineer]
    J -->|Deploy & Monitor| K[Production Ready]
```

### Princ√≠pios (Seguindo Connector-Dict)
1. **Clean Architecture**: Domain ‚Üí Application ‚Üí Infrastructure ‚Üí Handlers
2. **Event-Driven**: Pulsar events para alertas ass√≠ncronos
3. **Temporal Workflows**: Para monitoramento cont√≠nuo com cron
4. **Repository Pattern**: Acesso a dados via interfaces
5. **gRPC via Bridge**: Toda comunica√ß√£o com DICT via Bridge
6. **Observability First**: OpenTelemetry em todas as camadas
7. **Test-Driven**: Tests antes de implementa√ß√£o
8. **BACEN Compliance**: 100% conformidade com Manual Cap. 19

### Padr√µes de Qualidade
- **Test Coverage**: >85%
- **Go Idiomaticity**: golangci-lint score A
- **Security**: Valida√ß√£o de inputs, secrets management
- **Performance**: Queries otimizados (indexes, partitions)
- **Observability**: Full OpenTelemetry instrumentation

## üöÄ Fases de Execu√ß√£o

### Fase 0: Coordena√ß√£o & An√°lise (2 dias)
**Objetivo**: Verificar depend√™ncias externas

**Deliverables**:
- [x] **CR√çTICO**: Coordenar com time Bridge ‚úÖ CONCLU√çDO
  - ‚úÖ Endpoints `/policies` e `/policies/{policy}` EXISTEM
  - ‚úÖ Mappers XML ‚Üî gRPC dispon√≠veis
  - ‚úÖ Sem bloqueadores de integra√ß√£o
- [ ] Analisar estrutura de Entry/Key do connector-dict (domain layer)
- [ ] Verificar conex√£o PostgreSQL existente (reutilizar configura√ß√£o)
- [ ] Verificar Pulsar setup atual (topics, publishers)
- [ ] Documentar descobertas em `ANALISE_DEPENDENCIAS.md`
- [ ] ‚ö†Ô∏è **Pendente**: Consultar categoria PSP real do LBPay (A-H)
- [x] ‚úÖ **RESOLVIDO**: Secrets management = AWS Secrets Manager

---

### Fase 1: Dict API Implementation (Semana 1)
**Objetivo**: Endpoints REST funcionais

**Deliverables**:
- [ ] Schemas (ListPoliciesRequest/Response, GetPolicyRequest/Response)
- [ ] Controllers e handlers HTTP
- [ ] Application layer (use cases)
- [ ] Bridge gRPC Client
- [ ] ‚ùå **REMOVIDO**: Cache Redis (sempre consultar DICT)
- [ ] Parsear `<ResponseTime>` do DICT para timestamp de auditoria
- [ ] Unit tests (>90% coverage)
- [ ] Integration tests com mock Bridge

---

### Fase 2: Database Layer (Semana 1)
**Objetivo**: Schema e repositories

**Deliverables**:
- [ ] Migrations SQL (3 tabelas + indexes + partitions 13 meses)
- [ ] Adicionar colunas: `psp_category`, `consumption_rate_per_minute`, `recovery_eta_seconds`, `exhaustion_projection_seconds`, `error_404_rate`
- [ ] Repository interfaces (domain/ratelimit/)
- [ ] Repository implementations (infrastructure/database/repositories/ratelimit/)
- [ ] Unit tests (>90% coverage)
- [ ] Performance test (queries otimizados)

---

### Fase 3: Domain & Business Logic (Semana 2)
**Objetivo**: L√≥gica de an√°lise de thresholds

**Deliverables**:
- [ ] Domain entities (Policy, PolicyState, Alert)
- [ ] Threshold analyzer (WARNING: 20%, CRITICAL: 10%) - CORRIGIDO
- [ ] Utilization calculator (available/capacity * 100)
- [ ] **NOVO**: ETA recovery calculator (tempo at√© 100% de fichas)
- [ ] **NOVO**: Exhaustion projection calculator (proje√ß√£o de esgotamento)
- [ ] **NOVO**: Error 404 rate calculator (anti-scan detection)
- [ ] **NOVO**: Category change detector (PSP category monitoring)
- [ ] Unit tests com casos de teste variados

---

### Fase 4: Temporal Workflows (Semana 2-3)
**Objetivo**: Orquestra√ß√£o de monitoramento

**Deliverables**:
- [ ] MonitorPoliciesWorkflow (cron: */5 * * * *)
- [ ] AlertLowBalanceWorkflow (child workflow opcional)
- [ ] Todas as activities (6+ activities)
- [ ] Temporal Service implementation
- [ ] Setup cron em temporal.go
- [ ] Workflow replay tests

---

### Fase 5: Pulsar Integration (Semana 3)
**Objetivo**: Event publishing

**Deliverables**:
- [ ] Topic configuration (rate-limit-alerts)
- [ ] AlertPublisher implementation
- [ ] MetricsPublisher implementation
- [ ] Schema definitions (Avro/JSON)
- [ ] Integration tests com Testcontainers

---

### Fase 6: Observability (Semana 3)
**Objetivo**: M√©tricas e alertas

**Deliverables**:
- [ ] Prometheus metrics (gauges para cada policy)
- [ ] **NOVO**: M√©trica `dict_rate_limit_404_rate` (anti-scan)
- [ ] **NOVO**: M√©trica `dict_rate_limit_recovery_eta_seconds`
- [ ] **NOVO**: M√©trica `dict_rate_limit_exhaustion_projection_seconds`
- [ ] ‚ùå **REMOVIDO**: Grafana dashboard template (p√≥s-lan√ßamento)
- [ ] OpenTelemetry traces
- [ ] Alert rules (Prometheus AlertManager)
- [ ] ‚ùå **REMOVIDO**: PagerDuty/Slack integration (p√≥s-lan√ßamento)

---

### Fase 7: Quality & Compliance (Semana 4)
**Objetivo**: Testing e validation

**Deliverables**:
- [ ] E2E tests (full flow)
- [ ] Load tests (simular lat√™ncia DICT)
- [ ] Security audit
- [ ] BACEN compliance checklist (100%)
- [ ] Code review completo

---

### Fase 8: Documentation & Deployment (Semana 4)
**Objetivo**: Production readiness

**Deliverables**:
- [ ] Architecture docs + diagrams
- [ ] Operational runbooks
- [ ] Monitoring dashboards
- [ ] Alerts configuration
- [ ] Migration scripts
- [ ] Rollback procedures

## üìä M√©tricas de Sucesso

| M√©trica | Target | Medi√ß√£o |
|---------|--------|---------|
| Test Coverage | >85% | go test -cover |
| API Response Time (p99) | <200ms | Prometheus histogram |
| ‚ùå Cache Hit Rate | N/A | Removido (sem cache) |
| Workflow Success Rate | >99% | Temporal dashboard |
| Alert Accuracy | 100% | Manual validation |
| Database Query Time (p99) | <50ms | pgx metrics |
| BACEN Compliance | 100% | Security audit |
| Cron Execution Success | >99.9% | Temporal metrics |
| Error 404 Rate | <20% | Prometheus gauge |
| Recovery ETA Accuracy | ¬±5% | Domain logic validation |
| Exhaustion Projection Accuracy | ¬±10% | Domain logic validation |
| Category Change Detection | 100% | Event log validation |

## üîó Refer√™ncias

- **BACEN Manual**: Cap√≠tulo 19 - Consulta de Baldes (RF_Dict_Bacen.md)
- **Connector-Dict**: [github.com/lb-conn/connector-dict](https://github.com/lb-conn/connector-dict)
- **Bridge**: [github.com/lb-conn/rsfn-connect-bacen-bridge](https://github.com/lb-conn/rsfn-connect-bacen-bridge)
- **Instru√ß√µes Dict API**: `.claude/Specs_do_Stackholder/instrucoes-app-dict.md`
- **Instru√ß√µes Orchestration Worker**: `.claude/Specs_do_Stackholder/instrucoes-orchestration-worker.md`
- **Instru√ß√µes Gerais**: `.claude/Specs_do_Stackholder/instrucoes-gerais.md`
- **Arquitetura Token Bucket**: `.claude/Specs_do_Stackholder/arquiteto_Stacholder.md`

---

## üéØ Pr√≥ximos Passos Imediatos

1. ‚úÖ **Coordenar com Time Bridge** - CONCLU√çDO
   - ‚úÖ Endpoints `/policies` e `/policies/{policy}` EXISTEM
   - ‚úÖ Mappers XML ‚Üî gRPC dispon√≠veis
   - ‚úÖ Sem bloqueadores de integra√ß√£o

2. ‚úÖ **Definir Thresholds Definitivos** - VALIDADO
   - ‚úÖ WARNING: 20% restante (80% utilizado)
   - ‚úÖ CRITICAL: 10% restante (90% utilizado)

3. ‚ö†Ô∏è **Pend√™ncias Cr√≠ticas**
   - ‚ö†Ô∏è Consultar categoria PSP real do LBPay (A-H) via DICT
   - ‚úÖ Secrets management = AWS Secrets Manager (RESOLVIDO)

4. **Iniciar Fase 1** (Dict API Engineer)
   - Criar schemas seguindo padr√£o Huma
   - Implementar controllers (SEM cache)
   - Parsear `<ResponseTime>` do DICT

5. **Paralelizar Fase 2** (DB & Domain Engineer)
   - Criar migrations com novas colunas (category, ETA, projection, 404_rate)
   - Implementar repositories

---

## üìù Hist√≥rico de Mudan√ßas

### 2025-11-01 - Atualiza√ß√£o baseada em DUVIDAS.md
- üî¥ Threshold WARNING corrigido: 25% ‚Üí 20%
- üî¥ Cache Redis removido (sempre consultar DICT)
- üî¥ Grafana/PagerDuty movidos para p√≥s-lan√ßamento
- ‚ûï Adicionadas m√©tricas de 404 rate (anti-scan)
- ‚ûï Adicionado c√°lculo de ETA recovery
- ‚ûï Adicionada proje√ß√£o de esgotamento
- ‚ûï Adicionado monitoramento de mudan√ßa de categoria PSP
- ‚ûï Timestamp do DICT (`<ResponseTime>`) como autoridade
- ‚ûï Timezone UTC for√ßado (`TZ=UTC`)
- ‚úÖ Bridge endpoints confirmados (sem bloqueadores)
- ‚úÖ AWS Secrets Manager definido (mTLS, DB credentials)
- ‚ö†Ô∏è Categoria PSP pendente (necessita consulta real ao DICT)

Veja [CHANGES_REPORT.md](../../CHANGES_REPORT.md) para detalhes completos.
Veja [BRIDGE_ENDPOINTS_RATE_LIMIT.md](./.claude/BRIDGE_ENDPOINTS_RATE_LIMIT.md) para integra√ß√£o com Bridge.

---

**√öltima Atualiza√ß√£o**: 2025-11-01
**Respons√°vel**: Tech Lead
**Status**: ‚úÖ ESPECIFICA√á√ÉO ATUALIZADA - PRONTO PARA FASE 1 (Implementa√ß√£o)

**Pr√≥ximo Passo**: Iniciar Fase 1 (Dict API) e Fase 2 (Database) em paralelo

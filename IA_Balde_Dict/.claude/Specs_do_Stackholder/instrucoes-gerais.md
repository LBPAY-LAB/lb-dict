# Guia de Implementa√ß√£o de Novas Funcionalidades

## Vis√£o Geral

Este diret√≥rio cont√©m instru√ß√µes detalhadas para cria√ß√£o de novas funcionalidades no projeto **connector-dict**. O projeto √© composto por duas aplica√ß√µes principais que trabalham em conjunto:

1. **Dict API** (`apps/dict`) ‚Äî API REST que recebe requisi√ß√µes dos clientes
2. **Orchestration Worker** (`apps/orchestration-worker`) ‚Äî Worker Temporal que processa workflows ass√≠ncronos

---

## üéØ Quando Implementar uma Nova Funcionalidade

Quando uma **nova funcionalidade/endpoint** for necess√°ria, voc√™ **DEVE** implementar em **AMBAS** as aplica√ß√µes seguindo a ordem abaixo:

### **Passo 1: Dict API** (Camada de Entrada)

üìÑ **Documento:** [`instrucoes-app-dict.md`](./instrucoes-app-dict.md)

**Responsabilidades:**

- Receber requisi√ß√µes REST via Huma
- Validar schemas de entrada
- Opera√ß√µes **s√≠ncronas (GET)**: Consultar diretamente via gRPC (Bridge)
- Opera√ß√µes **ass√≠ncronas (POST/PUT/DELETE)**:
  - Gerar hash determin√≠stico (requestID)
  - Consultar cache Redis
  - Publicar mensagem no Pulsar
  - Retornar 202 Accepted

**Tecnologias:**

- Framework HTTP: Huma
- Cache: Redis
- Messaging: Pulsar (Producer)
- Comunica√ß√£o s√≠ncrona: gRPC Client

---

### **Passo 2: Orchestration Worker** (Camada de Processamento)

üìÑ **Documento:** [`instrucoes-orchestration-worker.md`](./instrucoes-orchestration-worker.md)

**Responsabilidades:**

- Consumir mensagens do Pulsar
- Orquestrar workflows Temporal para opera√ß√µes ass√≠ncronas
- Executar chamadas gRPC para Bridge/BACEN
- Gravar respostas no cache Redis
- Publicar eventos de sucesso/falha (CoreEvents, DictEvents)
- Gerenciar workflows de monitoramento e expira√ß√£o

**Tecnologias:**

- Orquestra√ß√£o: Temporal
- Messaging: Pulsar (Consumer)
- Cache: Redis
- Comunica√ß√£o: gRPC Client

---

## üîÑ Fluxo Completo de uma Opera√ß√£o

### **Opera√ß√µes Ass√≠ncronas (POST/PUT/DELETE)**

```mermaid
sequenceDiagram
    participant Client
    participant DictAPI
    participant Redis
    participant Pulsar
    participant Worker
    participant gRPC
    participant BACEN

    Client->>DictAPI: POST /claims
    DictAPI->>DictAPI: Gerar requestID (hash)
    DictAPI->>Redis: Consultar cache
    Redis-->>DictAPI: Cache miss
    DictAPI->>Pulsar: Publicar evento
    DictAPI-->>Client: 202 Accepted {request_id}

    Pulsar->>Worker: Consumir mensagem
    Worker->>Worker: Iniciar Workflow Temporal
    Worker->>gRPC: CreateClaim
    gRPC->>BACEN: CreateClaim
    BACEN-->>gRPC: Response
    gRPC-->>Worker: Response
    Worker->>Redis: Gravar resposta (cache)
    Worker->>Pulsar: Publicar CoreEvents
    Worker->>Pulsar: Publicar DictEvents
    Worker->>Worker: Iniciar Child Workflows (monitor)

    Client->>DictAPI: GET /requests/{request_id}
    DictAPI->>Redis: Consultar cache
    Redis-->>DictAPI: Response (cached)
    DictAPI-->>Client: 200 OK {response}
```

### **Opera√ß√µes S√≠ncronas (GET)**

```mermaid
sequenceDiagram
    participant Client
    participant DictAPI
    participant gRPC
    participant Bridge

    Client->>DictAPI: GET /claims/{id}
    DictAPI->>gRPC: GetClaim
    gRPC->>Bridge: GetClaim
    Bridge-->>gRPC: Response
    gRPC-->>DictAPI: Response
    DictAPI-->>Client: 200 OK {claim}
```

---

## üìã Checklist de Implementa√ß√£o

Ao criar uma nova funcionalidade, siga esta ordem:

### ‚úÖ **1. Dict API** (consulte [`instrucoes-app-dict.md`](./instrucoes-app-dict.md))

- [ ] **Schemas** (`handlers/http/schemas/<resource>/`)

  - [ ] Request schema com valida√ß√µes
  - [ ] Response schema com requestID (async) ou dados diretos (sync)
  - [ ] Mapper functions

- [ ] **Controller** (`handlers/http/<resource>/`)

  - [ ] controller.go com RegisterRoutes
  - [ ] Handlers individuais (create, get, update, delete, etc.)
  - [ ] Valida√ß√£o de schemas
  - [ ] Convers√£o de erros

- [ ] **Application** (`application/<resource>/`)

  - [ ] application.go com inje√ß√£o de depend√™ncias
  - [ ] interface.go com contratos
  - [ ] Use cases para cada opera√ß√£o
  - [ ] L√≥gica: async (cache + pulsar) ou sync (gRPC)

- [ ] **Infrastructure** (se necess√°rio)

  - [ ] gRPC client (`infrastructure/grpc/<resource>/`)

- [ ] **Setup** (`setup/`)

  - [ ] Adicionar t√≥picos Pulsar ao config.go
  - [ ] Criar publishers no setup.go
  - [ ] Injetar depend√™ncias no setup.go
  - [ ] Registrar rotas no RegisterRoutes()

- [ ] **Vari√°veis de Ambiente**
  - [ ] Adicionar t√≥picos Pulsar ao .env

---

### ‚úÖ **2. Orchestration Worker** (consulte [`instrucoes-orchestration-worker.md`](./instrucoes-orchestration-worker.md))

- [ ] **Handlers Pulsar** (`handlers/pulsar/<resource>/`)

  - [ ] <resource>\_handler.go com struct Handler
  - [ ] Handlers para cada a√ß√£o (create, update, delete)
  - [ ] Parse de MessageProperties
  - [ ] Decode de payload
  - [ ] Delega√ß√£o para use case

- [ ] **Application Use Cases** (`application/usecases/<resource>/`)

  - [ ] application.go com inje√ß√£o de depend√™ncias
  - [ ] Use case para cada opera√ß√£o (delega para service)

- [ ] **Application Ports** (`application/ports/`)

  - [ ] Interface do service (<Resource>Service)

- [ ] **Temporal Workflows** (`infrastructure/temporal/workflows/<resource>s/`)

  - [ ] **Workflows de A√ß√£o:**
    - [ ] create_workflow.go (gRPC ‚Üí Cache ‚Üí Events)
    - [ ] update_workflow.go
    - [ ] delete_workflow.go
  - [ ] **Workflows de Monitoramento** (se aplic√°vel):
    - [ ] monitor\_<resource>\_workflow.go (polling peri√≥dico)
    - [ ] expire\_<resource>\_workflow.go (deadline tracking)
  - [ ] shared.go (helpers compartilhados)

- [ ] **Temporal Activities** (`infrastructure/temporal/activities/<resource>s/`)

  - [ ] <resource>\_activity.go (struct Activity)
  - [ ] create_activity.go (gRPC call + error classification)
  - [ ] get_activity.go (para polling)
  - [ ] update_activity.go
  - [ ] delete_activity.go

- [ ] **Temporal Service** (`infrastructure/temporal/services/`)

  - [ ] <resource>\_service.go (ExecuteWorkflow)
  - [ ] Implementar interface de ports
  - [ ] Configurar WorkflowOptions (ID, TaskQueue, ReusePolicy)

- [ ] **Setup** (`setup/`)

  - [ ] Adicionar t√≥picos ao config.go
  - [ ] Registrar workflows no temporal.go
  - [ ] Registrar activities no temporal.go
  - [ ] Adicionar consumer Pulsar no pulsar.go
  - [ ] Injetar depend√™ncias no setup.go

- [ ] **Vari√°veis de Ambiente**
  - [ ] Adicionar t√≥picos Pulsar ao .env

---

## üéì Exemplos de Refer√™ncia

### **Recurso Completo: Claim**

Use `Claim` como exemplo de refer√™ncia **em ambas as aplica√ß√µes**:

#### **Dict API:**

- Schemas: `apps/dict/handlers/http/schemas/claim/`
- Controller: `apps/dict/handlers/http/claim/`
- Application: `apps/dict/application/claim/`
- Setup: `apps/dict/setup/setup.go`

**Opera√ß√µes:**

- ‚úÖ Async: CreateClaim, ConfirmClaim, CancelClaim, CompleteClaim
- ‚úÖ Sync: GetClaim, ListClaims

#### **Orchestration Worker:**

- Handlers: `apps/orchestration-worker/handlers/pulsar/claim/`
- Use Cases: `apps/orchestration-worker/application/usecases/claim/`
- Workflows: `apps/orchestration-worker/infrastructure/temporal/workflows/claims/`
- Activities: `apps/orchestration-worker/infrastructure/temporal/activities/claims/`
- Service: `apps/orchestration-worker/infrastructure/temporal/services/claim_service.go`

**Workflows:**

- ‚úÖ A√ß√£o: CreateClaimWorkflow, CancelClaimWorkflow, CompleteClaimWorkflow
- ‚úÖ Monitor: MonitorClaimStatusWorkflow, ExpireCompletionPeriodEndWorkflow

---

## üîë Conceitos-Chave

### **Idempot√™ncia**

- **Dict API:** Hash determin√≠stico (requestID) via `domain.Fingerprint()`
- **Orchestration Worker:** Workflow ID = requestID
- **Resultado:** M√∫ltiplas requisi√ß√µes id√™nticas retornam mesma resposta do cache

### **Comunica√ß√£o Ass√≠ncrona**

- **Dict API ‚Üí Pulsar:** Publicar evento com correlationID
- **Pulsar ‚Üí Orchestration Worker:** Consumir e iniciar workflow
- **Orchestration Worker ‚Üí Redis:** Gravar resposta
- **Client ‚Üí Dict API:** Consultar resposta via `/requests/{request_id}`

### **Comunica√ß√£o S√≠ncrona**

- **Dict API ‚Üí gRPC Bridge:** Chamada direta (GET operations)
- **Orchestration Worker ‚Üí gRPC Bridge:** Dentro de activities

### **Cache Redis**

- **Formato:** Envelope type-safe (`SetWithError`)
- **TTL:** Configur√°vel por opera√ß√£o
- **Uso:** Armazenar respostas (sucesso ou erro)

### **Continue-As-New (Temporal)**

- **Quando:** Workflows de longa dura√ß√£o (monitoramento)
- **Por qu√™:** Evitar hist√≥rico gigante
- **Como:** `workflow.NewContinueAsNewError(ctx, WorkflowFunc, input)`

---

## üì¶ Depend√™ncias entre Aplica√ß√µes

### **Dict API depende de:**

- ‚úÖ Schemas do SDK compartilhado (`github.com/lb-conn/sdk-rsfn-validator`)
- ‚úÖ Pulsar (publisher)
- ‚úÖ Redis (cache)
- ‚úÖ gRPC Bridge (opera√ß√µes GET)

### **Orchestration Worker depende de:**

- ‚úÖ Schemas do SDK compartilhado (`github.com/lb-conn/sdk-rsfn-validator`)
- ‚úÖ Pulsar (consumer + publishers)
- ‚úÖ Redis (cache)
- ‚úÖ Temporal (workflows + activities)
- ‚úÖ gRPC Bridge (todas as opera√ß√µes BACEN)

### **Comunica√ß√£o:**

```
Dict API ‚Üí Pulsar ‚Üí Orchestration Worker
Dict API ‚Üí Redis ‚Üê Orchestration Worker
Dict API ‚Üí gRPC Bridge ‚Üê Orchestration Worker
```

---

## ‚ö†Ô∏è Regras Importantes

### **Dict API:**

1. ‚úÖ POST/PUT/DELETE ‚Üí **sempre ass√≠ncrono** (cache + pulsar + 202)
2. ‚úÖ GET ‚Üí **sempre s√≠ncrono** (gRPC + 200)
3. ‚úÖ Sempre validar schemas com `.Validate()`
4. ‚úÖ Sempre converter erros com `adapters.ConvertDomainError()`
5. ‚úÖ Sempre logar opera√ß√µes importantes

### **Orchestration Worker:**

1. ‚úÖ Workflows de a√ß√£o: gRPC ‚Üí Cache ‚Üí CoreEvents ‚Üí DictEvents
2. ‚úÖ Workflows de monitoramento: Polling + Continue-As-New
3. ‚úÖ Activities: Classificar erros (retryable vs non-retryable)
4. ‚úÖ Sempre usar helpers compartilhados (`ExecuteCacheActivity`, etc.)
5. ‚úÖ Child workflows: `ParentClosePolicy: ABANDON`
6. ‚úÖ Workflow ID = requestID (idempot√™ncia)

---

## üöÄ Pr√≥ximos Passos

1. **Leia os documentos espec√≠ficos:**

   - [`instrucoes-app-dict.md`](./instrucoes-app-dict.md) ‚Äî Dict API
   - [`instrucoes-orchestration-worker.md`](./instrucoes-orchestration-worker.md) ‚Äî Orchestration Worker

2. **Analise o exemplo de refer√™ncia (Claim)** em ambas as aplica√ß√µes

3. **Implemente seguindo a ordem:**

   - Passo 1: Dict API (endpoint REST)
   - Passo 2: Orchestration Worker (workflow Temporal)

4. **Teste a integra√ß√£o completa:**
   - Enviar requisi√ß√£o para Dict API
   - Verificar processamento no Orchestration Worker
   - Consultar resposta via `/requests/{request_id}`

---

## üí° Dicas

- ‚úÖ Use os templates dos documentos como ponto de partida
- ‚úÖ Copie e adapte o c√≥digo de `Claim` (exemplo completo)
- ‚úÖ Sempre adicione logs estruturados com contexto
- ‚úÖ Sempre teste com diferentes cen√°rios (sucesso, erro, timeout, etc.)
- ‚úÖ Sempre implemente testes unit√°rios
- ‚úÖ Sempre documente vari√°veis de ambiente no README
